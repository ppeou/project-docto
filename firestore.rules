rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isCreator() {
      return isAuthenticated() && 
             resource.data.created.by == request.auth.uid;
    }

    function willBeCreator() {
      return isAuthenticated() && 
             request.resource.data.created.by == request.auth.uid;
    }

    function isNotDeleted() {
      return resource.data.isDeleted == false;
    }

    function willNotBeDeleted() {
      return request.resource.data.isDeleted == false;
    }

    // Users collection
    match /users/{userId} {
      // Allow read if user owns the document (even if it doesn't exist yet)
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isOwner(userId) && 
                       request.resource.data.id == request.auth.uid &&
                       request.resource.data.email == request.auth.token.email;
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    // Patients collection
    match /patients/{patientId} {
      // Allow read if user owns the patient and it's not deleted
      // For queries, Firestore checks each document individually
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      (resource.data.userId == request.auth.uid && isNotDeleted()));
      
      // Allow create if user sets themselves as owner
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.created.by == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user owns the patient
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.created.by == resource.data.created.by;
      
      // Allow delete (soft delete) if user owns the patient
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }

    // Doctors collection
    match /doctors/{doctorId} {
      // Allow read if user owns the doctor and it's not deleted
      // For queries, Firestore checks each document individually
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      (resource.data.userId == request.auth.uid && isNotDeleted()));
      
      // Allow create if user sets themselves as owner
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.created.by == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user owns the doctor
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.created.by == resource.data.created.by;
      
      // Allow delete (soft delete) if user owns the doctor
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }

    // Itineraries collection
    match /itineraries/{itineraryId} {
      // Allow read if user created it and it's not deleted
      // For queries, Firestore checks each document individually
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      (resource.data.created.by == request.auth.uid && isNotDeleted()));
      
      // Allow create if user is the creator and required fields are present
      allow create: if isAuthenticated() && 
                       willBeCreator() &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       request.resource.data.created.by == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user is the creator and doesn't change ownership
      allow update: if isAuthenticated() && 
                       isCreator() &&
                       request.resource.data.created.by == resource.data.created.by &&
                       request.resource.data.isDeleted == resource.data.isDeleted;
      
      // Allow delete (soft delete) if user is the creator
      allow delete: if isAuthenticated() && isCreator();
    }

    // Appointments collection
    match /appointments/{appointmentId} {
      // Helper function to check if user created the itinerary
      function itineraryCreator() {
        return resource.data.itineraryId != null &&
               get(/databases/$(database)/documents/itineraries/$(resource.data.itineraryId)).data.created.by == request.auth.uid;
      }
      
      // Allow read if user created it OR created the itinerary it belongs to
      // For queries, Firestore checks each document individually
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      ((resource.data.created.by == request.auth.uid || itineraryCreator()) && isNotDeleted()));
      
      // Allow create if user is the creator and required fields are present
      allow create: if isAuthenticated() && 
                       willBeCreator() &&
                       request.resource.data.title is string &&
                       request.resource.data.title.size() > 0 &&
                       request.resource.data.appointmentDate is timestamp &&
                       request.resource.data.created.by == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user is the creator and doesn't change ownership
      allow update: if isAuthenticated() && 
                       isCreator() &&
                       request.resource.data.created.by == resource.data.created.by &&
                       request.resource.data.isDeleted == resource.data.isDeleted;
      
      // Allow delete (soft delete) if user is the creator
      allow delete: if isAuthenticated() && isCreator();
    }

    // Prescriptions collection
    match /prescriptions/{prescriptionId} {
      // Helper function to check if user created the itinerary
      function itineraryCreator() {
        return resource.data.itineraryId != null &&
               get(/databases/$(database)/documents/itineraries/$(resource.data.itineraryId)).data.created.by == request.auth.uid;
      }
      
      // Allow read if user created it OR created the itinerary it belongs to
      // For queries, Firestore checks each document individually
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      ((resource.data.created.by == request.auth.uid || itineraryCreator()) && isNotDeleted()));
      
      // Allow create if user is the creator and required fields are present
      allow create: if isAuthenticated() && 
                       willBeCreator() &&
                       request.resource.data.medicationName is string &&
                       request.resource.data.medicationName.size() > 0 &&
                       request.resource.data.created.by == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user is the creator and doesn't change ownership
      allow update: if isAuthenticated() && 
                       isCreator() &&
                       request.resource.data.created.by == resource.data.created.by &&
                       request.resource.data.isDeleted == resource.data.isDeleted;
      
      // Allow delete (soft delete) if user is the creator
      allow delete: if isAuthenticated() && isCreator();
    }

    // Doctor Notes collection
    match /doctorNotes/{noteId} {
      // Helper function to check if user created the itinerary
      // Doctor notes always have an itineraryId according to schema
      function itineraryCreator() {
        return resource.data.itineraryId != null &&
               exists(/databases/$(database)/documents/itineraries/$(resource.data.itineraryId)) &&
               get(/databases/$(database)/documents/itineraries/$(resource.data.itineraryId)).data.created.by == request.auth.uid;
      }
      
      // Allow read if user created it OR created the itinerary it belongs to
      // For queries, Firestore checks each document individually
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      ((resource.data.created.by == request.auth.uid || itineraryCreator()) && isNotDeleted()));
      
      // Allow create if user is the creator and required fields are present
      allow create: if isAuthenticated() && 
                       willBeCreator() &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.created.by == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user is the creator and doesn't change ownership
      allow update: if isAuthenticated() && 
                       isCreator() &&
                       request.resource.data.created.by == resource.data.created.by &&
                       request.resource.data.isDeleted == resource.data.isDeleted;
      
      // Allow delete (soft delete) if user is the creator
      allow delete: if isAuthenticated() && isCreator();
    }

    // Invitations collection
    match /invitations/{invitationId} {
      // Allow read if user is the inviter or invitee
      allow read: if isAuthenticated() && 
                     (resource.data.invitedBy == request.auth.uid ||
                      resource.data.inviteeIdentifier == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email);
      
      // Allow create if user is the inviter
      allow create: if isAuthenticated() && 
                       request.resource.data.invitedBy == request.auth.uid;
      
      // Allow update if user is the inviter or invitee (for accepting/declining)
      allow update: if isAuthenticated() && 
                       (resource.data.invitedBy == request.auth.uid ||
                        resource.data.inviteeIdentifier == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email);
      
      // Allow delete if user is the inviter
      allow delete: if isAuthenticated() && 
                       resource.data.invitedBy == request.auth.uid;
    }

    // Itinerary Shares collection
    match /itineraryShares/{shareId} {
      // Allow read if user is the sharer or sharee and it's not deleted
      allow read: if isAuthenticated() && 
                     (resource.data.sharedWith == request.auth.uid ||
                      resource.data.sharedBy == request.auth.uid) &&
                     isNotDeleted();
      
      // Allow create if user is the sharer
      allow create: if isAuthenticated() && 
                       request.resource.data.sharedBy == request.auth.uid &&
                       willNotBeDeleted();
      
      // Allow update if user is the sharer
      allow update: if isAuthenticated() && 
                       resource.data.sharedBy == request.auth.uid &&
                       request.resource.data.sharedBy == resource.data.sharedBy;
      
      // Allow delete if user is the sharer or sharee
      allow delete: if isAuthenticated() && 
                       (resource.data.sharedBy == request.auth.uid ||
                        resource.data.sharedWith == request.auth.uid);
    }

    // Specialties collection
    match /specialties/{specialtyId} {
      // Allow read for all authenticated users (including queries)
      allow read: if isAuthenticated();
      // Allow create for authenticated users
      allow create: if isAuthenticated() && 
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0;
      // Allow update for authenticated users
      allow update: if isAuthenticated() && 
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0;
      // Allow delete for authenticated users
      allow delete: if isAuthenticated();
    }

    // Frequency Options collection
    match /frequencyOptions/{optionId} {
      // TEMPORARILY DISABLED RULES FOR INITIALIZATION
      // TODO: Re-enable proper rules after initialization is complete
      // Allow all operations for authenticated users (no validation)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      // Rules to re-enable after initialization:
      // allow read: if isAuthenticated() && 
      //                (!resource.exists || resource.data.isActive == true);
      // allow create: if isAuthenticated() && 
      //                 request.resource.data.label is string &&
      //                 request.resource.data.label.size() > 0 &&
      //                 request.resource.data.intervalValue is number &&
      //                 request.resource.data.intervalValue >= 0 &&
      //                 request.resource.data.intervalUnit is string &&
      //                 request.resource.data.intervalUnit in ['hour', 'day', 'week', 'month', 'as_needed'] &&
      //                 request.resource.data.displayOrder is int &&
      //                 request.resource.data.displayOrder >= 0;
      // allow update: if isAuthenticated() && [same validation as create]
      // allow delete: if false;
    }
  }
}
